<!DOCTYPE html>
<html>
<head>
  <title>PRTY Chat</title>
  <link rel="icon" type="image/png" href="assets/canvas.png">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

<div class="sidebar" id="sidebar">
  <h2>PRTY</h2>
  <a href="index.html">Home</a>
  <a href="games.html">Games</a>
  <a href="apps.html">Apps</a>
  <a href="movies.html">Movies</a>
  <a href="manga.html">Manga</a>
  <a href="proxy.html">Proxy</a>
  <a href="radio.html">PRTY Radio</a>
  <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
</div>

<div class="main" style="padding-bottom:90px;">
  <h1 style="color:#00ffff;text-shadow:0 0 10px #ff00cc;text-align:center;">
    ðŸ’¬ PRTY Chat (Beta)
  </h1>

  <div id="chat-box" style="
    max-width:900px;
    margin:20px auto;
    height:65vh;
    overflow-y:auto;
    background:#000;
    border-radius:15px;
    padding:15px;
    box-shadow:0 0 25px rgba(0,255,255,0.25);
  "></div>
</div>

<div style="
  position:fixed;
  bottom:0;
  left:220px;
  right:0;
  background:rgba(0,0,0,0.9);
  backdrop-filter:blur(10px);
  padding:15px;
  display:flex;
  gap:10px;
  box-shadow:0 -5px 20px rgba(0,255,255,0.2);
">
  <input id="chat-input" placeholder="Type a message as Guest..."
    style="
      flex:1;
      padding:12px;
      border-radius:25px;
      border:none;
      outline:none;
      background:#111;
      color:#fff;
      font-size:14px;
    ">
  <button onclick="sendMessage()" style="
    background:linear-gradient(135deg,#ff00cc,#00ffff);
    border:none;
    padding:12px 20px;
    border-radius:25px;
    font-weight:bold;
    cursor:pointer;
  ">Send</button>
</div>

<script src="js/main.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, limitToLast, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyADI7CVjt1NGlqCTWkOG85gIa_z7DbVdaU",
  authDomain: "prty-chat-e6360.firebaseapp.com",
  databaseURL: "https://prty-chat-e6360-default-rtdb.firebaseio.com",
  projectId: "prty-chat-e6360",
  storageBucket: "prty-chat-e6360.firebasestorage.app",
  messagingSenderId: "742478924958",
  appId: "1:742478924958:web:c1ca28df6b8ecc18997f8f",
  measurementId: "G-9LTCFMENBF"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let guestId = localStorage.getItem("prty_guest_id");
if (!guestId) {
  guestId = Math.floor(10000000 + Math.random() * 90000000);
  localStorage.setItem("prty_guest_id", guestId);
}

let lastMessageTime = 0;
const SLOWMODE = 2000;
const chatBox = document.getElementById("chat-box");
const input = document.getElementById("chat-input");

const messagesRef = query(ref(db, "messages"), limitToLast(100));

onValue(messagesRef, (snapshot) => {
  chatBox.innerHTML = "";
  const data = snapshot.val();
  if (!data) return;

  Object.values(data).forEach(msg => {
    const div = document.createElement("div");
    div.style.padding = "8px 12px";
    div.style.marginBottom = "8px";
    div.style.borderRadius = "10px";
    div.style.background = msg.id == guestId ? "#111" : "#0a0a0a";
    div.style.borderLeft = msg.id == guestId ? "3px solid #00ffff" : "3px solid #ff00cc";
    div.innerHTML = `<b style="color:#00ffff;">Guest ${msg.id}</b>: ${escapeHTML(msg.text)}`;
    chatBox.appendChild(div);
  });

  chatBox.scrollTop = chatBox.scrollHeight;
});

window.sendMessage = function() {
  const text = input.value.trim();
  const now = Date.now();

  if (!text) return;
  if (text.length > 200) return alert("Message too long");
  if (now - lastMessageTime < SLOWMODE) return alert("Slowmode: wait 2 seconds");

  const spamCheck = /(.)\1{8,}/;
  if (spamCheck.test(text)) return alert("Spam detected");

  push(ref(db, "messages"), {
    id: guestId,
    text: text,
    time: now
  });

  lastMessageTime = now;
  input.value = "";
};

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, function(tag) {
    const chars = {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;"
    };
    return chars[tag] || tag;
  });
}

input.addEventListener("keypress", function(e) {
  if (e.key === "Enter") sendMessage();
});
</script>

</body>
</html>
